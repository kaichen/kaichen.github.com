
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Kai Way</title>
  <meta name="author" content="Kai Chen">

  
  <meta name="description" content="Recently I have to fight with older version IE, that&rsquo;s really a
nightmare. And then search some resources to fight with it. http://www. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kaichen.github.io/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="The Kai Way" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16480900-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">The Kai Way</a></h1>
  
    <h2>Pragmaticly hacking</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kaichen.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/inspect-rails">Inspect Rails</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/04/06/web-resources-help-you-fight-with-older-IE">Web Resources Help You Fight With Older IEs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-06T00:00:00+08:00" pubdate data-updated="true">Apr 6<span>th</span>, 2012</time>
        
         | <a href="/2012/04/06/web-resources-help-you-fight-with-older-IE#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I have to fight with older version IE, that&rsquo;s really a
nightmare.</p>

<p>And then search some resources to fight with it.</p>

<ul>
<li><a href="http://www.sitepoint.com/10-fixes-for-ie6-problems/">http://www.sitepoint.com/10-fixes-for-ie6-problems/</a></li>
<li><a href="http://stylisticweb.com/design-tutorials/15-ie6-bugs-and-simple-solutions">http://stylisticweb.com/design-tutorials/15-ie6-bugs-and-simple-solutions</a></li>
<li><a href="http://css-tricks.com/ie-css-bugs-thatll-get-you-every-time/">http://css-tricks.com/ie-css-bugs-thatll-get-you-every-time/</a></li>
<li><a href="http://www.virtuosimedia.com/dev/css/ultimate-ie6-cheatsheet-how-to-fix-25-internet-explorer-6-bugs#understanding-hasLayout">http://www.virtuosimedia.com/dev/css/ultimate-ie6-cheatsheet-how-to-fix-25-internet-explorer-6-bugs#understanding-hasLayout</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/04/02/use-multi-buckets-in-carrierwave-upyun">Carrierwave-upyun配置多个不同buckets</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-02T00:00:00+08:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2012</time>
        
         | <a href="/2012/04/02/use-multi-buckets-in-carrierwave-upyun#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>背景</h1>

<p><a href="https://github.com/jnicklas/carrierwave/">carrierwave</a>是RubyOnRails社区中比较
流行的文件上传插件，<a href="https://github.com/nowa/carrierwave-upyun">carrierwave-upyun</a>
是集成<a href="https://github.com/nowa/carrierwave-upyun">upyun</a>服务的插件。</p>

<h1>把不同类型的文件存放到upyun不同的bucket上</h1>

<p>使用upyun时有个常见的需求就是把不同类型的图片分开放到不同的bucket当中，但在
carreirwave-upyun的文档当中并没有提到这点，只是给出了怎么配置全局参数的例子：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="ss">:upyun</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">upyun_username</span> <span class="o">=</span> <span class="s2">&quot;xxxxxx&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">upyun_password</span> <span class="o">=</span> <span class="s1">&#39;xxxxxx&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">upyun_bucket</span> <span class="o">=</span> <span class="s2">&quot;my_bucket&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">upyun_bucket_domain</span> <span class="o">=</span> <span class="s2">&quot;my_bucket.files.example.com&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>解决</h1>

<p>而实际上，可以这么去做：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CoverUploader</span> <span class="o">&lt;</span> <span class="ss">CarrierWave</span><span class="p">:</span><span class="ss">:Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">storage</span> <span class="ss">:upyun</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">upyun_bucket</span> <span class="o">=</span> <span class="s2">&quot;my-covers&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AttachementUploader</span> <span class="o">&lt;</span> <span class="ss">CarrierWave</span><span class="p">:</span><span class="ss">:Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">storage</span> <span class="ss">:upyun</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">upyun_bucket</span> <span class="o">=</span> <span class="s2">&quot;my-attachements&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样简单地在Uploader里assign一下就可以解决问题。</p>

<h1>为什么以上的解决方法行得通？</h1>

<p>Carreirwave的各种Configuration都是通过这里的<code>add_config</code>方法加入的。代码可以看以下的链接</p>

<p><a href="https://github.com/jnicklas/carrierwave/blob/master/lib/carrierwave/uploader/configuration.rb#L75-L94">https://github.com/jnicklas/carrierwave/blob/master/lib/carrierwave/uploader/configuration.rb#L75-L94</a></p>

<p><code>add_config</code>为每个Uploader实例添加了直接访问Class variable的方法，Uploader中
的各种Configuration 项（比如这里的<code>upyun_bucket</code>）都是存储在Uploader的Class
中。</p>

<p>而所有默认的Configuration项都是存储在<code>CarrierWave::Uploader::Base</code>，所以在我们
自定义的Uploader可以通过<code>add_config</code>为我们加入的<a href="https://github.com/jnicklas/carrierwave/blob/master/lib/carrierwave/uploader/configuration.rb#L98-L92"><code>self.#{config_item}=</code></a>
去修改Configuration项。</p>

<p>也就是说Carrierwave一早就实现了这样的机制让不同的Uploader天生可以具有配置能力。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/03/11/use-weekly-to-fetch-tech-updates">Use Weekly to Fetch Tech Updates</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-11T00:00:00+08:00" pubdate data-updated="true">Mar 11<span>th</span>, 2012</time>
        
         | <a href="/2012/03/11/use-weekly-to-fetch-tech-updates#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>我现在获取技术更新的来源，从订阅各种RSS改为订阅各类Weekly Mail。</p>

<p>比起RSS，Weekly的优点不少：</p>

<ul>
<li>更少的噪音，订阅某个Blog或者News site的RSS往往附带很多噪音</li>
<li>更少的信息量，Weekly中已经是人工筛选过，更重要的信息</li>
<li>减少阅读时间，每周读几封Weekly比时不时就去看RSS花更少的时间</li>
<li>清理RSS，大大减少RSS的未阅读数量</li>
</ul>


<p>现在RSS里剩下的内容，只有名人和大牛的博客（如韩寒，云风等），或者没有相关Weekly的内容。</p>

<p>以下是我订阅的几个Weekly</p>

<ul>
<li>Ruby Weekly <a href="http://rubyweekly.com/">http://rubyweekly.com/</a></li>
<li>HTML5 Weekly <a href="http://html5weekly.com/">http://html5weekly.com/</a></li>
<li>JavaScript Weekly <a href="http://javascriptweekly.com/">http://javascriptweekly.com/</a></li>
<li>Coder Weekly <a href="http://coderweekly.com/">http://coderweekly.com/</a></li>
</ul>


<p>以上全部Weekly Mail都是免费的，<strong>值得一提的是前3份都是大牛 <a href="http://peterc.org/">Peter Cooper</a> 搞的</strong>。</p>

<p>另外我还订一个Hacker News的monthly，是将HN上热门的内容制作成精美的ebook，有PDF，iPad版的PDF，epub和mobi。订阅地址是，<a href="http://hackermonthly.com/">http://hackermonthly.com/</a>。这个是付费，一年$29。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/01/08/play-a-http-toy-server-with-eventmachine">Play a HTTP Toy Server With EventMachine</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-08T00:00:00+08:00" pubdate data-updated="true">Jan 8<span>th</span>, 2012</time>
        
         | <a href="/2012/01/08/play-a-http-toy-server-with-eventmachine#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://www.faconneurs.enligne-fr.com/__/logos_clients/event_machine.JPG" alt="EventMachine" /></p>

<p><a href="https://github.com/eventmachine/eventmachine/wiki">EventMachine</a>是Ruby社区的<a href="http://en.wikipedia.org/wiki/Reactor_pattern">Reactor模式</a>的实现。</p>

<p>所谓<code>Reactor</code>模式，通过运行一个事件循环，将输入分发给对应的处理器，处理过程全权交给处理器，从而实现同时处理多个输入，是实现高并发的利器。几乎每个语言都有对应的实现，比如Pythong的<a href="http://twistedmatrix.com/trac/">Twisted</a>，最近很火的<a href="nodejs.org/">Node.js</a>。</p>

<p>这次我们通过实现一个简单的HTTP File server来探索EventMachine。</p>

<p>通过Rubygems可以安装它：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>gem install eventmachine
</span></code></pre></td></tr></table></div></figure>


<h3>Beginning Sample</h3>

<p>我们先从一个简单的例子入手，以下代码实现了这样的一个服务器，打印发过来数据，并返回<code>Yike</code>。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">TcpSample</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">] receive </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;Yike</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="sx">%w{INT TERM}</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="no">Signal</span><span class="o">.</span><span class="n">trap</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nb">proc</span><span class="p">{</span><span class="no">EM</span><span class="o">.</span><span class="n">stop_event_loop</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">port</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;PORT&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">8001</span>
</span><span class='line'>  <span class="n">host</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;HOST&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">start_server</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="no">TcpSample</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Server start on </span><span class="si">#{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>来解释几个EventMachine的API：</p>

<ul>
<li><a href="http://eventmachine.rubyforge.org/EventMachine.html#M000461">EM.run</a> 这个方法初始化并启动一个事件循环。</li>
<li><a href="http://eventmachine.rubyforge.org/EventMachine.html#M000469">EM.stop_event_loop</a> 这个方法顾名思义就是停止事件循环。在这段代码中我们注册了两个Signal，INT和TERM，用来在命令行用Ctrl-C停止程序。</li>
<li><a href="http://eventmachine.rubyforge.org/EventMachine.html#M000470">EM.start_server</a> 启动一个TCP服务器并监听传入参数的host和port，最后一个传入的参数是具体的行为逻辑实现，可以是Module或者是Class。</li>
</ul>


<p>代码中TcpSample module就是具体的Connection逻辑实现，只要实现几个由EventMachine Connection约定的方法，比如收发数据的<code>receive_data</code>和<code>send_data</code>。EventMachine会在运行过程事件被触发时回调Connection里的方法。具体关于EventMachine::Connection的文档请点击<a href="http://eventmachine.rubyforge.org/EventMachine/Connection.html">这里</a>。</p>

<p>我们可以用telnet来测试它：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>telnet 127.0.0.1 8001
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to localhost.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'>hey
</span><span class='line'>Yike
</span></code></pre></td></tr></table></div></figure>


<p>第一个简单的例子就这样演示完成了，继续下一步。</p>

<h3>Toy File Server</h3>

<p>接着步入正题，实现HTTP File Server。一句话来解释HTTP服务器做的事情，就是解析来自客户的Request，然后依照请求生成Response。这里的演示代码如题目所示，只是个Toy，按照请求返回静态文件。</p>

<p>首先需要接受并解析Request。EventMachine已经附带了<a href="http://eventmachine.rubyforge.org/EventMachine/Protocols.html">好几种Protocol的解析</a>，其中包括实现了HTTP的<a href="http://eventmachine.rubyforge.org/EventMachine/Protocols/HeaderAndContentProtocol.html">HeaderAndContentProtocol</a>。注意这里的各种Protocol实现都是继承第一个例子中讲到EventMachine::Connection，并为各自的协议包装了一个<code>receive_xxx</code>的回调方法，HeaderAndContentProtocol的回调方法名为<code>receive_request</code>。我们的HTTP Toy要做的就是继承<code>HeaderAndContentProtocol</code>，在<code>receive_request</code>方法中实现File Server的逻辑。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HTTPToy</span> <span class="o">&lt;</span> <span class="ss">EM</span><span class="p">:</span><span class="ss">:P</span><span class="o">::</span><span class="no">HeaderAndContentProtocol</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_request</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span>
</span><span class='line'>    <span class="c1">#TODO ...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>先来完成HTTP Headers的解析：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">REGEX</span> <span class="o">=</span> <span class="sr">/\A(?&lt;request_method&gt;\w+) (?&lt;full_path&gt;\S+) HTTP\/(?&lt;version&gt;[\d.]+)\Z/</span>
</span><span class='line'><span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="o">|</span>
</span><span class='line'>    <span class="n">matched</span> <span class="o">=</span> <span class="no">REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>
</span><span class='line'>    <span class="n">req</span><span class="o">[</span><span class="s2">&quot;request_method&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">matched</span><span class="o">[</span><span class="ss">:request_method</span><span class="o">]</span>
</span><span class='line'>    <span class="n">req</span><span class="o">[</span><span class="s2">&quot;full_path&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">matched</span><span class="o">[</span><span class="ss">:full_path</span><span class="o">]</span>
</span><span class='line'>    <span class="n">req</span><span class="o">[</span><span class="s2">&quot;http_version&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">matched</span><span class="o">[</span><span class="ss">:version</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着实现Callback方法<code>receive_request</code>，主要的逻辑是查找文件和拼装Response并返回：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">receive_request</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span>
</span><span class='line'>  <span class="vi">@request</span> <span class="o">=</span> <span class="n">parse_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
</span><span class='line'>  <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="vi">@request</span><span class="o">[</span><span class="s2">&quot;full_path&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@request</span><span class="o">[</span><span class="s2">&quot;full_path&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;./index.html&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>    <span class="n">serve_file</span> <span class="n">filename</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">respond_not_found</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">ensure</span>
</span><span class='line'>  <span class="n">close_connection_after_writing</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">serve_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="n">extname</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="n">send_headers</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                 <span class="s2">&quot;html&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="s2">&quot;js&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/x-javascript&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="s2">&quot;css&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/css&quot;</span>
</span><span class='line'>               <span class="p">}(</span><span class="n">extname</span><span class="p">)</span>
</span><span class='line'>  <span class="n">send_data</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">send_headers</span><span class="p">(</span><span class="n">more</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>  <span class="n">request</span><span class="o">[</span><span class="s2">&quot;status&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">more</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&quot;200 OK&quot;</span>
</span><span class='line'>  <span class="n">headers</span> <span class="o">=</span> <span class="s2">&quot;HTTP/1.1 </span><span class="si">#{</span><span class="n">request</span><span class="o">[</span><span class="s1">&#39;status&#39;</span><span class="o">]</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">more</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1"># the magic string &quot;+8000&quot; means my life is at HARD MODE</span>
</span><span class='line'>    <span class="s2">&quot;Date&quot;</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, %d %b %Y %H:%m:%S +8000&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="s2">&quot;Server&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;my-http-toy&quot;</span>
</span><span class='line'>  <span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">more</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">more</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="n">more</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">headers</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">send_data</span> <span class="n">headers</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上代码的<code>close_connection_after_writing</code>方法也是EventMachine的API之一，文档在<a href="http://eventmachine.rubyforge.org/EventMachine/Connection.html#M000286">这里</a>。这个方法会等待<code>send_data</code>的完成再把与客户端之间的连接关闭。上述大段代码的作用就是读文件并用<code>send_data</code>返回。</p>

<p>把它跑起来并通过浏览器可以测试一下它：</p>

<p><img src="http://dl.dropbox.com/u/1080383/screenshot-my-http-toy.png" alt="screenshot" /></p>

<p>查看完整的实现代码请点击<a href="http://gist.github.com/1580890">这里</a>。</p>

<h3>Benchmark</h3>

<p>最后来对比异步IO和同步的IO效率相差有多大，和本文实现的简单http file server对比的是Rack。用Rack来做对比是因为它几乎是最小最快的HTTP File server实现。代码如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># file: config.ru</span>
</span><span class='line'><span class="n">run</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>压力测试用的是<a href="http://www.hpl.hp.com/research/linux/httperf/">HTTPerf</a>，作为测试Fixture的是一个名为index.html的小文件（47B）。</p>

<p>Rack的File middleware在并发超过350的情况就歇菜了：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rackup</span> <span class="o">.</span><span class="n">/config</span><span class="o">.</span><span class="n">ru</span> <span class="o">-</span><span class="nb">p</span> <span class="mi">8002</span>
</span><span class='line'><span class="err">$</span> <span class="n">httperf</span> <span class="o">--</span><span class="n">rate</span><span class="o">=</span><span class="mi">350</span> <span class="o">--</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">conns</span><span class="o">=</span><span class="mi">350</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">8002</span> <span class="o">--</span><span class="n">uri</span><span class="o">=</span><span class="sr">/index.html</span>
</span><span class='line'>
</span><span class='line'><span class="sr">Total: connections 350 requests 350 replies 347 test-duration 1.978 s</span>
</span><span class='line'>
</span><span class='line'><span class="sr">Connection rate: 177.0 conn/s</span> <span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="mi">7</span> <span class="n">ms</span><span class="o">/</span><span class="n">conn</span><span class="p">,</span> <span class="o">&lt;=</span><span class="mi">26</span> <span class="n">concurrent</span> <span class="n">connections</span><span class="p">)</span>
</span><span class='line'><span class="no">Connection</span> <span class="n">time</span> <span class="o">[</span><span class="n">ms</span><span class="o">]</span><span class="p">:</span> <span class="n">min</span> <span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="n">avg</span> <span class="mi">68</span><span class="o">.</span><span class="mi">5</span> <span class="n">max</span> <span class="mi">1272</span><span class="o">.</span><span class="mi">6</span> <span class="n">median</span> <span class="mi">13</span><span class="o">.</span><span class="mi">5</span> <span class="n">stddev</span> <span class="mi">245</span><span class="o">.</span><span class="mi">5</span>
</span><span class='line'><span class="no">Connection</span> <span class="n">time</span> <span class="o">[</span><span class="n">ms</span><span class="o">]</span><span class="p">:</span> <span class="n">connect</span> <span class="mi">63</span><span class="o">.</span><span class="mi">6</span>
</span><span class='line'><span class="no">Connection</span> <span class="n">length</span> <span class="o">[</span><span class="n">replies</span><span class="o">/</span><span class="n">conn</span><span class="o">]</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span>
</span><span class='line'>
</span><span class='line'><span class="no">Request</span> <span class="ss">rate</span><span class="p">:</span> <span class="mi">177</span><span class="o">.</span><span class="mi">0</span> <span class="n">req</span><span class="o">/</span><span class="n">s</span> <span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="mi">7</span> <span class="n">ms</span><span class="o">/</span><span class="n">req</span><span class="p">)</span>
</span><span class='line'><span class="no">Request</span> <span class="n">size</span> <span class="o">[</span><span class="n">B</span><span class="o">]</span><span class="p">:</span> <span class="mi">72</span><span class="o">.</span><span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>350个并发的请求用了接近2秒的时间，速度是177个连接每秒。接着再来测试我们的HTTPToy：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby ./httptoy.rb 8001
</span><span class='line'><span class="nv">$ </span>httperf --rate<span class="o">=</span>600 --timeout<span class="o">=</span>5 --num-conns<span class="o">=</span>600 --port<span class="o">=</span>8001 --uri<span class="o">=</span>/index.html
</span><span class='line'>
</span><span class='line'>Total: connections 600 requests 600 replies 600 <span class="nb">test</span>-duration 1.000 s
</span><span class='line'>
</span><span class='line'>Connection rate: 600.1 conn/s <span class="o">(</span>1.7 ms/conn, &lt;<span class="o">=</span>17 concurrent connections<span class="o">)</span>
</span><span class='line'>Connection <span class="nb">time</span> <span class="o">[</span>ms<span class="o">]</span>: min 0.4 avg 2.8 max 25.9 median 0.5 stddev 3.9
</span><span class='line'>Connection <span class="nb">time</span> <span class="o">[</span>ms<span class="o">]</span>: connect 0.2
</span><span class='line'>Connection length <span class="o">[</span>replies/conn<span class="o">]</span>: 1.000
</span><span class='line'>
</span><span class='line'>Request rate: 600.1 req/s <span class="o">(</span>1.7 ms/req<span class="o">)</span>
</span><span class='line'>Request size <span class="o">[</span>B<span class="o">]</span>: 72.0
</span></code></pre></td></tr></table></div></figure>


<p><strong>完胜</strong>，和前面的差距不是一星半点，一秒内响应600个连接。如果继续提高并发数，到了700以上我们的HTTPToy也会出现不稳定的情况（崩溃或连接失败）。</p>

<h3>Conclusion</h3>

<p>EventMachine应用的场景和Node.js基本一样，IO密集的高并发场景，比如</p>

<ul>
<li>Web Socket服务端，<a href="https://github.com/igrigorik/em-websocket">https://github.com/igrigorik/em-websocket</a></li>
<li>并发的HTTP Client，<a href="https://github.com/igrigorik/em-http-request">https://github.com/igrigorik/em-http-request</a></li>
<li>Proxy，<a href="https://github.com/igrigorik/em-proxy">https://github.com/igrigorik/em-proxy</a></li>
</ul>


<p>在生产环境中大量使用EventMachine公司就是<a href="www.postrank.com/">PostRank</a>，这个公司基于EventMachine开发了大量的框架和库，有兴趣可以点击<a href="https://github.com/igrigorik">igrigorik</a>和<a href="https://github.com/postrank-labs">postrank-labs</a>的Github帐号。</p>

<p>最后谈下EventMachine缺点，和其它的Reactor模式实现一样，对付CPU密集的应用不行，而且使用的库全部都必须是异步，不然会把Main Event Loop阻塞（其后果是处理速度大大降低）。而像Node.js程序里出现了大量Callback的情况，在EventMachine上会好一点。</p>

<p>本文中的运行环境是Mac OSX Lion，Ruby 1.9.3-p0。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/20/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB">如何阅读</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-20T00:00:00+08:00" pubdate data-updated="true">Nov 20<span>th</span>, 2011</time>
        
         | <a href="/2011/11/20/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>阅读</h1>

<p>结构化的知识大都是通过阅读书籍得到的，所以阅读是学习的重要途径之一。</p>

<h2>阅读的结果</h2>

<p>获得以下四个问题的答案：</p>

<ul>
<li>_这本书讲了什么？_</li>
<li>_作者详细讲述了什么？怎么讲？_</li>
<li>_这本书讲得有道理吗？是全部都有道理还是只有部分？_</li>
<li>_为什么要读这本书？获得了什么信息，得到了什么启发？_</li>
</ul>


<h2>做笔记</h2>

<ul>
<li>_划线_</li>
<li>_作记号_</li>
<li>_记下当时的问题_</li>
<li>_记下感想_</li>
</ul>


<h2>理解的技巧</h2>

<ul>
<li>_通过书名对书本做分类_</li>
<li>_把握内容的结构_</li>
<li>_找到重点的字词句_</li>
<li>_判断作者的主旨_</li>
<li>_评判该书_</li>
<li>_赞同或反对作者_</li>
</ul>


<h2>快速阅读的技巧</h2>

<p>过慢的阅读速度并不一定能提高理解能力，但一定会影响精神状态。</p>

<p>更少的定焦能提高阅读速度，比如阅读一行文字仅用定位三次，可以通过指示物加快定焦（包括换行）</p>

<p>通过高速阅读练习（限制的眼睛定焦次数和时间｛3,2,1分钟内｝），实现高速效应，提高平时正常阅读速度。</p>

<h2>记忆</h2>

<p>有时需要在阅读后记忆一些事情，这需要理解人是怎么遗忘信息的。快速的多遍阅读记忆效果比一遍阅读强很多。</p>

<p>通过在<a href="http://en.wikipedia.org/wiki/Forgetting_curve" title="Forgetting Curve">遗忘曲线</a>上的几个拐点复习来巩固记忆的效果，这几个拐点分别是5分钟，30分钟，12小时，1天，2天和5天。</p>

<h2>后记</h2>

<p>本篇文章是我在读完文末列出的几本书之后写下的笔记。这几本是很有趣的书，让你在阅读中学习如何阅读的书。</p>

<h2>Refs</h2>

<ul>
<li><a href="http://book.douban.com/subject/1013208/">如何阅读一本书</a></li>
<li><a href="http://book.douban.com/subject/6064502/">超级快速阅读</a></li>
<li><a href="http://book.douban.com/subject/1803504/">17天搞定GRE单词</a></li>
<li><a href="http://en.wikipedia.org/wiki/Forgetting_curve" title="Forgetting Curve">http://en.wikipedia.org/wiki/Forgetting_curve</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/03/31/new-start">新起点</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-31T00:00:00+08:00" pubdate data-updated="true">Mar 31<span>st</span>, 2011</time>
        
         | <a href="/2011/03/31/new-start#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这个月开始我从<a href="http://theplant.jp">ThePlant</a>离职，加入<a href="http://intridea.com">Intridea</a>。</p>

<p>ThePlant是我毕业后第一个公司。算上在毕业前半年的时间，我已经为<a href="http://theplant.jp">ThePlant</a>工作了两年。在这两年里我学到了很多，和同事们一起也很开心，学到很多宝贵的经验，在此感谢<a href="http://theplant.jp">ThePlant</a>里的所有人。</p>

<p>经过这两年工作，我有了更多的思考，思考自己能做什么，需要去做什么，所以便有了换工作的理由。就是去和更多不同的优秀的开发者一起工作，理解更多解决问题的思路，验证在之前得到想法和经验是否正确，参与更多不同类型项目的开发，获得更多经验。</p>

<p>理由很简单是吗？真的就这么简单，我想进步想有更多提升。</p>

<p>新的工作是Remote work的形式，远程的沟通协作和更多自我管理。</p>

<p>新的发型 <a href="http://instagr.am/p/Bxu71">http://instagr.am/p/Bxu71</a> 和新的起点 <a href="http://intridea.com/about/people/kai">http://intridea.com/about/people/kai</a>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/04/29/learning-tinyrb-1">Learning Tinyrb 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-29T00:00:00+08:00" pubdate data-updated="true">Apr 29<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://code.macournoyer.com/tinyrb/">Tinyrb</a>，一个Ruby的实现，
<a href="http://macournoyer.com">作者Marc-André Cournoyer</a>计划实现参照Lua和Potion
实现来做出一个轻量级快速的Ruby实现，<a href="http://on-ruby.blogspot.com/2009/02/tinyrb-interview.html">
这是一个对作者关于Tinyrb想法的采访</a>。目前还不能直接运行mspec，或者是我不知道怎么运行mspec。</p>

<p>其中用了一些外挂：</p>

<ul>
<li>GC, Boehm-Demers-Weiser conservative garbage collector</li>
<li>语法解析(Lexical Parse), peg/leg</li>
<li>命令行选项解析(Command-Line Option Parse), Free Getopt</li>
<li>正则表达式解析(Regular Parse), PCRE (Perl-compatible regular expression library)</li>
</ul>


<p>Tinyrb到目前为止是个非常清晰简洁的实现，整个实现，VM+Ruby Library就200K多一点。编译运行非常简单，在Github上clone下来后make就行了。跑下Fib测试：</p>

<pre><code>~/ws/tinyrb &gt; time ruby bench/bm_app_fib.rb
real    0m10.866s
user    0m9.393s
sys 0m1.170s
~/ws/tinyrb &gt; time ruby-1.9 bench/bm_app_fib.rb
real    0m1.827s
user    0m1.423s
sys 0m0.013s
~/ws/tinyrb &gt; time jruby bench/bm_app_fib.rb
real    0m2.718s
user    0m2.447s
sys 0m0.097s
~/ws/tinyrb &gt; time tinyrb bench/bm_app_fib.rb
real    0m1.884s
user    0m1.680s
sys 0m0.007s
</code></pre>

<p>运行环境：Archlinux，kernal26-2.26.29，Core T8100，2G Mem。或许Tinyrb目前实现还不完全，启动速度比其它的Ruby实现就快了不少。</p>

<p>现在来剖析一下源码，我们从Tinyrb解析器启动入手，整个解析器的启动是在vm/tr.c文件中定义的：</p>

<pre><code>/* file: vm/tr.c */
int main (int argc, char *argv[]) {
  int opt;
  TrVM *vm = TrVM_new();
  while((opt = getopt(argc, argv, "e:vdh")) != -1) {
    switch(opt) {
      /* 参数解析 */
      ...
    }
  }
  /* 参数处理 */
  if (argc &gt; 0) {
    TR_FAILSAFE(TrVM_load(vm, argv[argc-1]));
    return 0;
  }
  TrVM_destroy(vm);
  return usage();
}
</code></pre>

<p>可以看到整个VM的启动由TrVM_new()开始</p>

<pre><code>/* file: vm/vm.c */
/* GC初始化 */
GC_INIT();
/* [A]VM分配空间并初始化 */
TrVM *vm = TR_ALLOC(TrVM);
vm-&gt;symbols = kh_init(str);
vm-&gt;globals = kh_init(OBJ);
vm-&gt;consts = kh_init(OBJ);
vm-&gt;debug = 0;
/* [B]初始化几个核心类Method，Symbol，Class，Object，Module */
TrMethod_init(vm);
TrSymbol_init(vm);
TrModule_init(vm);
TrClass_init(vm);
TrObject_preinit(vm);
TrClass *symbolc = (TrClass*)TR_CORE_CLASS(Symbol);
TrClass *modulec = (TrClass*)TR_CORE_CLASS(Module);
TrClass *classc = (TrClass*)TR_CORE_CLASS(Class);
TrClass *methodc = (TrClass*)TR_CORE_CLASS(Method);
TrClass *objectc = (TrClass*)TR_CORE_CLASS(Object);
/* [C]设置核心类的继承体系 */
symbolc-&gt;super = modulec-&gt;super = methodc-&gt;super = (OBJ)objectc;
classc-&gt;super = (OBJ)modulec;
/* [D]设置核心类的MetaClass */
symbolc-&gt;class = TrMetaClass_new(vm, objectc-&gt;class);
modulec-&gt;class = TrMetaClass_new(vm, objectc-&gt;class);
classc-&gt;class = TrMetaClass_new(vm, objectc-&gt;class);
methodc-&gt;class = TrMetaClass_new(vm, objectc-&gt;class);
objectc-&gt;class = TrMetaClass_new(vm, objectc-&gt;class);
/* [E]确保所有在Object之前创建的的Symbol的类得到初始化 */
TR_KH_EACH(vm-&gt;symbols, i, sym, {
  TR_COBJECT(sym)-&gt;class = (OBJ)symbolc;
});
/* [F]装入各种核心类 */
...
/* [G] */
vm-&gt;self = TrObject_alloc(vm, 0);
vm-&gt;cf = -1;
/* [H]缓存几个常用的值 */
vm-&gt;sADD = tr_intern("+");
vm-&gt;sSUB = tr_intern("-");
vm-&gt;sLT = tr_intern("&lt;");
vm-&gt;sNEG = tr_intern("@-");
vm-&gt;sNOT = tr_intern("!");
/* 装载Ruby Library（在lib/目录下的文件） */
TR_FAILSAFE(TrVM_load(vm, "lib/boot.rb"));
</code></pre>

<p>在GC完成初始化之后，代码中[A]部分完成了维护整个Tinyrb运行环境的虚拟机对象的空间分配和初始化，VM是个宏：</p>

<pre><code>#define VM TrVM *vm
</code></pre>

<p>TrVM这个VM的结构包括了什么：</p>

<pre><code>/* file: vm/tr.h */
typedef struct TrVM {
  khash_t(str) *symbols; /* 全局的符号表 */
  khash_t(OBJ) *globals; /* 全局对象 */
  khash_t(OBJ) *consts;  /* 全局常量 */
  OBJ classes[TR_T_MAX]; /* 虚拟机维护的核心类 */
  TrFrame *top_frame; /* 最顶层的栈幀（运行时栈的栈顶） */
  TrFrame *frame; /* 当前的栈幀 */
  int cf;   /* 栈幀的数量 count of frames */
  OBJ self; /* 根对象 */
  /* 调试和错误符号，还有一堆异常 */
  ...
  /* 几个缓存的对象 */
  OBJ sADD;
  OBJ sSUB;
  OBJ sLT;
  OBJ sNEG;
  OBJ sNOT;
};
</code></pre>

<p>在前一块代码中设置的symbols，globals，consts就是保存运行时（Runtime）环境的各种信息，这几个变量都是Hash。接着下面的是Tinyrb的几个核心类列表，这是一个枚举值。然后是运行环境必不可少的栈帧，作用域调用就是靠这个维护的。栈幀由对象栈幀，栈顶，栈幀数这几个变量维护。还有一个虚拟机环境的根对象，这个对象就是在整个运行环境最外层作用域的对象，Ruby能做到不像Java那样写个什么都要包覆在一个对象中就是靠这个对象实现的，这个对象混入了Kernel模块，后面会看到每个栈帧（TrFrame）中都会有一个这样对象存在。最后是调试标记和异常信息，暂时略过。最后的几个常用的对象，可以看到在TrVM_new()中的[H]处进行初始化。</p>

<p>在VM的初始化中，中间的大段代码就是复杂完成Tinyrb的对象体系的构建，由Method开始初始化：</p>

<pre><code>/* file:vm/class.c */
void TrMethod_init(VM) {
  OBJ c = TR_INIT_CORE_CLASS(Method, Object);
  tr_def(c, "name", TrMethod_name, 0);
  tr_def(c, "arity", TrMethod_arity, 0);
  tr_def(c, "dump", TrMethod_dump, 0);
}
</code></pre>

<p>TR_INIT_CORE_CLASS这个宏会引发一连串复杂的调用：</p>

<pre><code>/* file:vm/tr.h */
#define TR_INIT_CORE_OBJECT(T) ({ \
  Tr##T *o = TR_ALLOC(Tr##T); \
  o-&gt;type  = TR_T_##T; \
  o-&gt;class = vm-&gt;classes[TR_T_##T]; \
  o-&gt;ivars = kh_init(OBJ); \
  o; \
})
#define TR_CORE_CLASS(T)     vm-&gt;classes[TR_T_##T]
#define TR_INIT_CORE_CLASS(T,S) \
  TR_CORE_CLASS(T) = TrObject_const_set(vm, vm-&gt;self, tr_intern(#T), \
                                   TrClass_new(vm, tr_intern(#T), TR_CORE_CLASS(S)))
/* vm/class.c */
OBJ TrClass_new(VM, OBJ name, OBJ super) {
  TrClass *c = TR_INIT_CORE_OBJECT(Class);
  TR_INIT_MODULE(c);
  /* if VM is booting, those might not be set */
  if (super &amp;&amp; TR_CCLASS(super)-&gt;class) c-&gt;class = TrMetaClass_new(vm, TR_CCLASS(super)-&gt;class);
  c-&gt;super = super;
  return (OBJ)c;
}
#define TR_INIT_MODULE(M) \
  (M)-&gt;name = name; \
  (M)-&gt;methods = kh_init(OBJ); \
  (M)-&gt;meta = 0
</code></pre>

<p>TR_INIT_CORE_CLASS(Method, Object);展开如下</p>

<pre><code>TrClass *obj = TR_ALLOC(TrClass);
obj-&gt;type  = TR_T_Class;
obj-&gt;class = vm-&gt;classes[TR_T_Class];/* 实际上这句将其赋值为0，因为VM内部还没有创建Class类型 */
obj-&gt;ivars = kh_init(OBJ);
obj-&gt;name = tr_intern(Method);
obj-&gt;methods = kh_init(OBJ);
obj-&gt;meta = 0;
obj-&gt;super = vm-&gt;classes[TR_T_Object]; /* 实际上这句将其赋值为0，因为VM内部还没有创建Object类型 */
OBJ const_class = TrObject_const_set(vm, vm-&gt;self, tr_intern(Method), (OBJ)obj);
vm-&gt;classes[TR_T_Method]=const_class;
</code></pre>

<p>这样很清楚看到Method这个类初始化的过程，首先分配一个类（TrClass）的内存空间，接着设置所有的属性，之后把这个Method类设置到VM的常量列表，最后将这个Method类的对象地址保存到虚拟机的类型列表（Classes List）。注意这里其实Method类的class和super都是为0的。</p>

<p>顺便提一下，Tinyrb内部的对象类型（Object type）就是这个枚举值。</p>

<pre><code>/* file: vm/tr.h */
typedef enum {
  /*  0 */ TR_T_Object, TR_T_Module, TR_T_Class, TR_T_Method, TR_T_Binding,
  /*  5 */ TR_T_Symbol, TR_T_String, TR_T_Fixnum, TR_T_Range, TR_T_Regexp,
  /* 10 */ TR_T_NilClass, TR_T_TrueClass, TR_T_FalseClass,
  /* 12 */ TR_T_Array, TR_T_Hash,
  /* 14 */ TR_T_Node,
  TR_T_MAX /* keep last */
} TR_T;
</code></pre>

<p>当Method的属性设置完成之后接着就开始为其添加方法name()，arity(), dump()。添加方法是通过之前已经设置好的Method类，实例化三个Method Object，并把这三个对象添加到Method类的方法列表中，下面是tr_def(c, &ldquo;name&rdquo;, TrMethod_name, 0) 的展开：</p>

<pre><code>TrMethod *method = TR_INIT_CORE_OBJECT(Method); /* 初始化一个Method对象并返回 */
method-&gt;func = TrMethod_name;
method-&gt;data = TR_NIL;
method-&gt;arity = 0;
TrClass *m =  (TrClass*)E(vm-&gt;classes[TR_T_Method])
TR_KH_SET(m-&gt;methods, name, method);
method-&gt;name = name;
</code></pre>

<p>接着其它几个类型也类似的过程进行初始化:Symbol，Module，Class和Object。</p>

<p>到此为止VM的Const List已经有了这几个类Method，Symbol，Module，Class，Object，并且它们的第一个实例也已经保存到Classes List中。接着这些类的继承体系和剩下的核心类怎样初始化呢？请听下回分解。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/01/30/runtime-error-words-file-not-found">Runtime Error Words File Not Found of DataMapper</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-30T00:00:00+08:00" pubdate data-updated="true">Jan 30<span>th</span>, 2009</time>
        
         | <a href="/2009/01/30/runtime-error-words-file-not-found#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近运行测试时在跑到用dm-sweatshop创建fixtures时总是报RuntimeError words file not found，而出错的行包含/\w+/.gen，然后就开始折腾…</p>

<p>最初看到/\w+/.gen这种语法时觉得十分的新奇，还以为是dm-sweatshop的创意，原来是dm-sweatshop依赖的randexp库的魔法，而这背后原来是从系统的words文件中随机挑选出一个单词来实现的。<a href="http://en.wikipedia.org/wiki/Words_(Unix)" target="_blank">words file in Wikipedia</a></p>

<p>如果系统中没有words文件那在使用刀sweatshop的/\w+/.gen时就一直会报RuntimeError words file not found。而就是这个没有明确说明的依赖，让我折腾了好多天，因为系统中不一定一开始就有这个words文件，像在我用的ArchLinux上是由 words包提供的（貌似Ubuntu中是wbritish包）。</p>

<p>一开始我以为是DM又抽风了，就删了dm，然后又把整个rubygems删了。然后开始用grep和find搜索各种源码，先是在dm-more中找不到，接着去找ParseTree（sweatshop依赖它来完成unique {/\w+/.gen}）语法。最后读了一下sweatshop依赖中看到randexp，接着在randexp中搜索到了”words file not found”这个RuntimeError。</p>

<p>以上的做法比较S13，如果在使用sweatshop之前<a href="http://en.wikipedia.org/wiki/RTFM" target="_blank">RTFM</a>，就能看到它依赖于Randexp，然后如果再去看看源码，就不用折腾那么久XD</p>

<p>不过仔细读了一下sweatshop的源码，知道其中的猫腻，sweatshop为DataMapper::Model模块加入了几个方法：</p>

<p>fixtures：定义fixtures，和FactoryGirl的define差不多，可以用个Symbol指定名字，否则就为:defualt。方法缩写fix。
generate：使用之前fixtures方法中定义的属性值创建模型实例，调用的是模型的create方法。缩写gen。
generate!：同上，不过故名思义创建实例调用的方法是create!。缩写gen!。
generate_attributes：返回在fixtures方法中定义的属性Hash。类似FactoryGirl的attribute_for。
make：调用new创建实例，即不保存。
pick：返回一个由上述创建实例的方法创建的实例。一般用于关联，要将已创建的模型实例作为关联对象时使用。
sweatshop中维护了两个Hash，维护模型定义的model_map和维护实例（包括保存与未保存）的record_map。上述方法中 fixtures将模型定义加入model_map，gen/gen!/make方法则在创建实例后将其加入record_map中，pick方法就在 record_map中找出现存实例。</p>

<p>如果想要在FactoryGirl中使用/\w+/.gen就require ‘rendexp’这句就行了。</p>

<p>最后有个疑问，Rendexp这个包在win平台能用吗？</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/09/08/read-write-activerecord-attribute">Read and Write Activerecord Attribute</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/17/actionview-safe-buffer">ActionView Safe Buffer</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/16/rails-ujs">Rails ujs</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/10/actionview-architect">ActionView基本架构</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/30/config-your-git-push-strategy">配置Git Push策略</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Kai Chen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'thekaiway';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
